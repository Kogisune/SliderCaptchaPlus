(function(){"use strict";function t(t){var e=document.getElementById(t.id),i="object"==typeof t&&t;return new o(e,i)}var e=function(){var t=arguments.length,e=arguments[0]||{};"object"!=typeof e&&"function"!=typeof e&&(e={}),1==t&&(e=this,i--);for(var i=1;i<t;i++){var n=arguments[i];for(var o in n)Object.prototype.hasOwnProperty.call(n,o)&&(e[o]=n[o])}return e},i=function(t){return"function"==typeof t&&"number"!=typeof t.nodeType},o=function(t,i){this.$element=t,this.options=e({},o.DEFAULTS,i),this.$element.style.position="relative",this.$element.style.width=this.options.width+"px",this.$element.style.margin="0 auto",this.init()};let s=null;o.VERSION="1.01",o.Author="argo@163.com",o.PlusEditer="Kogisune",o.DEFAULTS={width:280,height:155,PI:Math.PI,sliderL:42,sliderR:9,offset:5,loadingText:"正在加载中...",failedText:"再试一次",barText:"向右滑动填充拼图",repeatIcon:"",sliderIcon:"",maxLoadCount:3,localImages:function(){return"images/Pic"+Math.round(4*Math.random())+".jpg"},encode:function(t){return t},data:null,verify:async function(t,e){let i=!1,o=new FormData;if(this.data)for(const t in this.data)o.append(t,this.data[t]);return o.append("data",this.encode(JSON.stringify(n))),await $.ajax({url:e,data:o,type:"POST",async:!1,processData:!1,contentType:!1,success:function(t){s=t,i=200==t.code}}),i},remoteUrl:null},window.sliderCaptcha=t,window.sliderCaptcha.Constructor=o;var r=o.prototype;r.init=function(){this.initDOM(),this.initImg(),this.bindEvents()},r.initDOM=function(){var t=function(t,e){var i=document.createElement(t);return i.className=e,i},n=function(t,e){var i=document.createElement("canvas");return i.width=t,i.height=e,i},o=n(this.options.width-2,this.options.height),s=o.cloneNode(!0),r=t("div","sliderContainer");let a=null;!1!==this.options.repeatIcon&&(this.options.repeatIcon?a=t("i","refreshIcon "+this.options.repeatIcon):(a=t("img","refreshIcon"),a.setAttribute("src","data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACgAAAAoCAYAAACM/rhtAAAELklEQVRYR+2YW2wUZRTH//9vtlCoF9IoIklT3PqgPGi326hoetuaGEhIr9SgCYkkgt2WGOQVCca+GavWdr0GjD4YhG3RB3hply1LQA1tEQIxEXapGI2pEkys9LIzx2ylYWfY6e5sF0oi+7hzzvl+3/9855xvhrjNf7zN+XAHcL4Z+n8o6JWTeYt++W25S596AIZy6TB+n3yo+Nchlk8vmIIVowdXU9c3Q1gDSilBlQwjgBAYFGDvdF58/4milqvZwDpOcXWsb5Uh8hmBqkwXFMhlCN8aX5LXNbRy/T+Z+iXsHAFWRXs3QGQPyLucLDJrK5DgUXdTsxPfjAEro8E3Ce50EtxsKxPTwCPH3U2jTmJkBJgWTnAMxDeGMEoa0xQ+LJQnCD4HYFkCyAC3RdwN3U7gMkpxRTTYrMD91sCJIgCxV5R6O1Jcfy7VwonqLoj9/CqB2kF341qncGkBvRe+ureAWpRgoalCBecMFzcdK24YymZRJz5zprgq1tsJwXYL3CVZGvdGHmwZc7JQtra2gE+f712ep2QUYP714DJhaJrXLqXZQszlZwtYdSHoB9ljVk/ePVrSZFL0ZkAlxzQBVseCT8WhZhRThtFB8plk9Zi/qCi8cv0fNxvKFrDy4oF11NXXIFy2EII4iBcG3Y03VLZT8OqRd5aFPduvOEpxRayvXolxAKB2g6NgEhobBlc1HHYKY7WvHf5wtVAPgegIlbbZ9seUZ7AyFnwewi9pGoUyDmhrB931kfnC1ZwOeKlLP8GZJi6QLSFP2yep4toXSbT3ZQAfX3O6omt8Nhd9r/aHQAUMOQywYBZo5uZD2ThQ2rbPCjlnH6yI9rUryE5DU75ctJaake46Be4DuDjF8dFBNA94/AdtiySVxIlpMlTS8td801o70vMigM9huTda2lhcKHVHPO2HZv/P6LIwX7hk/+qzPSvUJGMkrg8AQYTkroRdXMlE+HH/twsG6BsOdJHYZlaO/lBZ6weOiiSXqs3Gqj0TeAxx+T75DIpgwjC0onD51pQD4JaluPrkR/cpFT9DcoVp84LOgTL/DjtBbglgou+puHwB8lEznPxJw1XSX77VtgizBvQNBw4RMqB7xt4Lc3c8lQKJaQHoO4R8ydz0/7MWoCXk8c85MrMC9J3qaafw/WtQlwXST+F3BnAeYB4obgJ1BJIuG+YtiKAjVOZ/Pd1ZdwzoG+4uBtSPpjaRbhXLcwF3hzytb2TilgVgT5BkYybBrTYC+Rvg5nRpdTRJrIs8+VPXPQXj2i4ItxC4O2NQQUQnN4U9rRcz9nH64p4ceM2lziX5Y4s3KHCdUHwE77ecMkMEp6BwhIa2Z6DslZRvfulgHafYLuCas58WLp2aLCFUga70qxOFU6dPFL2W1feYeaU43Y5z/TxnCuYabMEuC043ckdBp4pZ7f8FE5psOI1g6fwAAAAASUVORK5CYII=")));var l=t("div","sliderMask"),d=t("div","sliderbg"),c=t("div","slider");let h=null;this.options.sliderIcon?h=t("i","sliderIcon "+this.options.sliderIcon):c.innerHTML='<div class="range-btn" style="width: 100%;height:100%;"><div></div><div></div><div></div></div>';var p=t("span","sliderText");s.className="block",p.innerHTML=this.options.barText;var u=this.$element;u.appendChild(o),u.appendChild(a),u.appendChild(s),h&&c.appendChild(h),l.appendChild(c),r.appendChild(d),r.appendChild(l),r.appendChild(p),u.appendChild(r);var f={canvas:o,block:s,sliderContainer:r,refreshIcon:a,slider:c,sliderMask:l,sliderIcon:h,text:p,canvasCtx:o.getContext("2d"),blockCtx:s.getContext("2d")};i(Object.assign)?Object.assign(this,f):e(this,f)},r.initImg=function(){var t=this,e=window.navigator.userAgent.indexOf("Trident")>-1,n=this.options.sliderL+2*this.options.sliderR+3,o=function(i,n){var o=t.options.sliderL,s=t.options.sliderR,r=t.options.PI,a=t.x,l=t.y;i.beginPath(),i.moveTo(a,l),i.arc(a+o/2,l-s+2,s,.72*r,2.26*r),i.lineTo(a+o,l),i.arc(a+o+s-2,l+o/2,s,1.21*r,2.78*r),i.lineTo(a+o,l+o),i.lineTo(a,l+o),i.arc(a+s-2,l+o/2,s+.4,2.76*r,1.24*r,!0),i.lineTo(a,l),i.lineWidth=2,i.fillStyle="rgba(255, 255, 255, 0.7)",i.strokeStyle="rgba(255, 255, 255, 0.7)",i.stroke(),i[n](),i.globalCompositeOperation=e?"xor":"destination-over"},s=function(t,e){return Math.round(Math.random()*(e-t)+t)},r=new Image;r.crossOrigin="Anonymous";var a=0;r.onload=function(){t.x=s(n+10,t.options.width-(n+10)),t.y=s(10+2*t.options.sliderR,t.options.height-(n+10)),o(t.canvasCtx,"fill"),o(t.blockCtx,"clip"),t.canvasCtx.drawImage(r,0,0,t.options.width-2,t.options.height),t.blockCtx.drawImage(r,0,0,t.options.width-2,t.options.height);var e=t.y-2*t.options.sliderR-1,i=t.blockCtx.getImageData(t.x-3,e,n,n);t.block.width=n,t.blockCtx.putImageData(i,0,e+1),t.text.textContent=t.text.getAttribute("data-text")},r.onerror=function(){if(a++,"file:"===window.location.protocol&&(a=t.options.maxLoadCount,console.error("can't load pic resource file from File protocal. Please try http or https")),a>=t.options.maxLoadCount)return t.text.textContent="加载失败",void t.classList.add("text-danger");r.src=t.options.localImages()},r.setSrc=function(){var n="";if(a=0,t.text.classList.remove("text-danger"),i(t.options.setSrc)&&(n=t.options.setSrc()),n&&""!==n||(n="https://picsum.photos/"+t.options.width+"/"+t.options.height+"/?image="+Math.round(20*Math.random())),e){var o=new XMLHttpRequest;o.onloadend=function(t){var e=new FileReader;e.readAsDataURL(t.target.response),e.onloadend=function(t){r.src=t.target.result}},o.open("GET",n),o.responseType="blob",o.send()}else r.src=n},r.setSrc(),this.text.setAttribute("data-text",this.options.barText),this.text.textContent=this.options.loadingText,this.img=r},r.clean=function(){this.canvasCtx.clearRect(0,0,this.options.width,this.options.height),this.blockCtx.clearRect(0,0,this.options.width,this.options.height),this.block.width=this.options.width},r.bindEvents=function(){var t=this;this.$element.addEventListener("selectstart",function(){return!1}),this.refreshIcon.addEventListener("click",function(){t.text.textContent=t.options.barText,t.reset(),i(t.options.onRefresh)&&t.options.onRefresh.call(t.$element)});var e,n,o=[],s=!1,r=function(i){t.text.classList.contains("text-danger")||(e=i.clientX||i.touches[0].clientX,n=i.clientY||i.touches[0].clientY,s=!0)},a=function(i){if(!s)return!1;var r=i.clientX||i.touches[0].clientX,a=i.clientY||i.touches[0].clientY,l=r-e,d=a-n;if(l<0||l+40>t.options.width)return!1;t.slider.style.left=l-1+"px";var c=(t.options.width-40-20)/(t.options.width-40)*l;t.block.style.left=c+"px",t.sliderContainer.classList.add("sliderContainer_active"),t.sliderMask.style.width=l+4+"px",o.push(Math.round(d))},l=function(n){if(!s)return!1;s=!1;var r=n.clientX||n.changedTouches[0].clientX;if(r===e)return!1;t.sliderContainer.classList.remove("sliderContainer_active"),t.trail=o;var a=t.verify();a.spliced&&a.verified?(t.sliderContainer.classList.add("sliderContainer_success"),i(t.options.onSuccess)&&t.options.onSuccess.call(t.$element)):(t.sliderContainer.classList.add("sliderContainer_fail"),i(t.options.onFail)&&t.options.onFail.call(t.$element),setTimeout(function(){t.text.innerHTML=t.options.failedText,t.reset()},1e3))};this.slider.addEventListener("mousedown",r),this.slider.addEventListener("touchstart",r),document.addEventListener("mousemove",a),document.addEventListener("touchmove",a),document.addEventListener("mouseup",l),document.addEventListener("touchend",l),document.addEventListener("mousedown",function(){return!1}),document.addEventListener("touchstart",function(){return!1}),document.addEventListener("swipe",function(){return!1})},r.verify=function(){var t=this.trail,e=parseInt(this.block.style.left),i=!1;if(null!==this.options.remoteUrl)i=this.options.verify(t,this.options.remoteUrl);else{var n=function(t,e){return t+e},o=function(t){return t*t},r=t.reduce(n)/t.length,a=t.map(function(t){return t-r}),l=Math.sqrt(a.map(o).reduce(n)/t.length);i=0!==l}return this.options.onVerified&&this.options.onVerified.call(this,s),{spliced:Math.abs(e-this.x)<this.options.offset,verified:i}},r.reset=function(){this.sliderContainer.classList.remove("sliderContainer_fail"),this.sliderContainer.classList.remove("sliderContainer_success"),this.slider.style.left=0,this.block.style.left=0,this.sliderMask.style.width=0,this.clean(),this.text.setAttribute("data-text",this.text.textContent),this.text.textContent=this.options.loadingText,this.img.setSrc()}})();